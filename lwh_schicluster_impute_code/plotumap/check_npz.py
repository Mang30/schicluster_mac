#!/usr/bin/env python3
"""
æ£€æŸ¥NPZæ–‡ä»¶å†…å®¹çš„è„šæœ¬
"""

import numpy as np
import os
from scipy.sparse import load_npz

def check_npz_file(file_path):
    """æ£€æŸ¥å•ä¸ªNPZæ–‡ä»¶çš„å†…å®¹"""
    print(f"=== æ£€æŸ¥æ–‡ä»¶: {os.path.basename(file_path)} ===")
    
    try:
        # æ–¹æ³•1ï¼šç›´æŽ¥ç”¨numpyåŠ è½½æŸ¥çœ‹å†…å®¹ç»“æž„
        with np.load(file_path) as data:
            print(f"NPZæ–‡ä»¶åŒ…å«çš„æ•°ç»„é”®: {list(data.keys())}")
            for key in data.keys():
                arr = data[key]
                print(f"  {key}: shape={arr.shape}, dtype={arr.dtype}")
                if hasattr(arr, 'size'):
                    print(f"    æ€»å…ƒç´ æ•°: {arr.size}")
        
        # æ–¹æ³•2ï¼šç”¨scipyåŠ è½½ç¨€ç–çŸ©é˜µ
        print(f"\n--- ç¨€ç–çŸ©é˜µè¯¦ç»†ä¿¡æ¯ ---")
        matrix = load_npz(file_path)
        print(f"çŸ©é˜µç±»åž‹: {type(matrix)}")
        print(f"çŸ©é˜µå½¢çŠ¶: {matrix.shape}")
        print(f"çŸ©é˜µæ•°æ®ç±»åž‹: {matrix.dtype}")
        print(f"éžé›¶å…ƒç´ æ•°é‡: {matrix.nnz:,}")
        
        total_elements = matrix.shape[0] * matrix.shape[1]
        sparsity = matrix.nnz / total_elements * 100
        print(f"æ€»å…ƒç´ æ•°é‡: {total_elements:,}")
        print(f"ç¨€ç–åº¦: {sparsity:.6f}%")
        print(f"é›¶å…ƒç´ æ¯”ä¾‹: {100-sparsity:.6f}%")
        
        # æŸ¥çœ‹æ•°æ®èŒƒå›´
        if matrix.nnz > 0:
            print(f"\n--- æ•°æ®ç»Ÿè®¡ ---")
            data = matrix.data  # éžé›¶å…ƒç´ çš„å€¼
            print(f"éžé›¶å€¼èŒƒå›´: [{data.min():.3f}, {data.max():.3f}]")
            print(f"éžé›¶å€¼å‡å€¼: {data.mean():.3f}")
            print(f"éžé›¶å€¼æ ‡å‡†å·®: {data.std():.3f}")
        
        # æŸ¥çœ‹çŸ©é˜µçš„ä¸€å°éƒ¨åˆ†æ•°æ®ç¤ºä¾‹
        print(f"\n--- çŸ©é˜µæ•°æ®ç¤ºä¾‹ (å·¦ä¸Šè§’10x10) ---")
        sample_size = min(10, matrix.shape[0], matrix.shape[1])
        dense_sample = matrix[:sample_size, :sample_size].toarray()
        print(dense_sample)
        
        return True
        
    except Exception as e:
        print(f"âŒ åŠ è½½æ–‡ä»¶å‡ºé”™: {e}")
        return False

def main():
    """ä¸»å‡½æ•°"""
    # æŸ¥æ‰¾å·²å­˜åœ¨çš„merged NPZæ–‡ä»¶
    output_dir = "/Volumes/SumSung500/CSU/0_HiRES/output/merged_matrices"
    
    print("ðŸ” æœç´¢NPZæ–‡ä»¶...")
    
    if not os.path.exists(output_dir):
        print(f"âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨: {output_dir}")
        return
    
    # é€’å½’æœç´¢æ‰€æœ‰NPZæ–‡ä»¶
    npz_files = []
    for root, dirs, files in os.walk(output_dir):
        for file in files:
            if file.endswith('_merged.npz'):
                npz_files.append(os.path.join(root, file))
    
    if not npz_files:
        print("âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•merged NPZæ–‡ä»¶")
        return
    
    print(f"âœ… æ‰¾åˆ° {len(npz_files)} ä¸ªNPZæ–‡ä»¶")
    
    # æ£€æŸ¥å‰å‡ ä¸ªæ–‡ä»¶ä½œä¸ºç¤ºä¾‹
    max_files_to_check = 3
    for i, file_path in enumerate(npz_files[:max_files_to_check]):
        print(f"\n{'='*60}")
        print(f"æ–‡ä»¶ {i+1}/{min(len(npz_files), max_files_to_check)}")
        success = check_npz_file(file_path)
        
        if not success:
            continue
    
    if len(npz_files) > max_files_to_check:
        print(f"\n... è¿˜æœ‰ {len(npz_files) - max_files_to_check} ä¸ªæ–‡ä»¶æœªæ˜¾ç¤º")

if __name__ == "__main__":
    main()
