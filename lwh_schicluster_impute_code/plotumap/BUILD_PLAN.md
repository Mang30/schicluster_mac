# ğŸš€ ä¸€é”®å¯åŠ¨è„šæœ¬æ„å»ºè®¡åˆ’

## ğŸ“‹ éœ€æ±‚åˆ†æ

### æ ¸å¿ƒåŠŸèƒ½
1. **è‡ªåŠ¨å‘ç° stages**: æ‰«æ `/output/imputed_matrices_by_stage` ä¸­çš„æ‰€æœ‰ stage ç›®å½•
2. **å®Œæ•´æµæ°´çº¿**: merge â†’ build h5ad â†’ generate UMAP
3. **å¿«é€Ÿæµ‹è¯•æ¨¡å¼**: æ”¯æŒå°æ ·æœ¬æµ‹è¯•éªŒè¯åŠŸèƒ½
4. **æ™ºèƒ½é€‰æ‹©**: æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜å¤„ç†æ–¹å¼ï¼ˆMPS/CUDA/CPUï¼‰

### è„šæœ¬å‚æ•°è®¾è®¡
```bash
./run.sh [é€‰é¡¹]

é€‰é¡¹:
  --mode MODE           è¿è¡Œæ¨¡å¼: all|test|stage
  --stages STAGES       æŒ‡å®šå¤„ç†çš„stages (é€—å·åˆ†éš”ï¼Œå¦‚ E70,E80)
  --max-cells N         æ¯ä¸ªstageæœ€å¤§å¤„ç†ç»†èƒæ•° (é»˜è®¤: all)
  --test-cells N        æµ‹è¯•æ¨¡å¼ä¸‹çš„ç»†èƒæ•° (é»˜è®¤: 3)
  --use-distance        ä½¿ç”¨è·ç¦»ç‰¹å¾ (æ›´å¿«ï¼Œæ¨è)
  --skip-merge          è·³è¿‡çŸ©é˜µåˆå¹¶æ­¥éª¤
  --skip-h5ad           è·³è¿‡h5adæ„å»ºæ­¥éª¤
  --skip-umap           è·³è¿‡UMAPå¯è§†åŒ–æ­¥éª¤
  --gpu-type TYPE       GPUç±»å‹: auto|mps|cuda|cpu (é»˜è®¤: auto)
  --help               æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

### è¿è¡Œæ¨¡å¼
1. **å…¨é‡æ¨¡å¼** (`--mode all`): å¤„ç†æ‰€æœ‰å‘ç°çš„stages
2. **æµ‹è¯•æ¨¡å¼** (`--mode test`): å¿«é€ŸåŠŸèƒ½éªŒè¯ (3ä¸ªç»†èƒ Ã— 3ä¸ªstages)
3. **æŒ‡å®šæ¨¡å¼** (`--mode stage --stages E70,E80`): å¤„ç†æŒ‡å®šstages

### è„šæœ¬ç»“æ„
```
run.sh
â”œâ”€â”€ å‚æ•°è§£æå’ŒéªŒè¯
â”œâ”€â”€ ç¯å¢ƒæ£€æµ‹ (ç¡¬ä»¶ã€ä¾èµ–)
â”œâ”€â”€ Stage è‡ªåŠ¨å‘ç°
â”œâ”€â”€ æµæ°´çº¿æ‰§è¡Œ
â”‚   â”œâ”€â”€ æ­¥éª¤1: çŸ©é˜µåˆå¹¶
â”‚   â”œâ”€â”€ æ­¥éª¤2: h5ad æ„å»º
â”‚   â””â”€â”€ æ­¥éª¤3: UMAP å¯è§†åŒ–
â”œâ”€â”€ è¿›åº¦ç›‘æ§å’Œæ—¥å¿—
â””â”€â”€ ç»“æœæ€»ç»“
```

### æ™ºèƒ½ç‰¹æ€§
1. **ç¡¬ä»¶æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹ Apple Silicon MPS / NVIDIA CUDA
2. **æ–­ç‚¹ç»­ä¼ **: æ£€æŸ¥å·²å®Œæˆçš„æ–‡ä»¶ï¼Œé¿å…é‡å¤å¤„ç†
3. **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤š stage å¹¶è¡Œå¤„ç†
4. **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†å•ä¸ªstageå¤±è´¥ï¼Œç»§ç»­å…¶ä»–stage
5. **èµ„æºç›‘æ§**: æ˜¾ç¤ºå¤„ç†è¿›åº¦ã€æ—¶é—´ä¼°ç®—ã€å†…å­˜ä½¿ç”¨

### è¾“å‡ºç»„ç»‡
```
output/
â”œâ”€â”€ merged_matrices/          # åˆå¹¶åçš„çŸ©é˜µ
â”œâ”€â”€ hic_h5ad_files/          # h5ad æ–‡ä»¶
â”œâ”€â”€ umap_plots/              # UMAP å›¾è¡¨
â”œâ”€â”€ logs/                    # è¿è¡Œæ—¥å¿—
â”‚   â”œâ”€â”€ run_YYYYMMDD_HHMMSS.log
â”‚   â””â”€â”€ summary.json
â””â”€â”€ reports/                 # å¤„ç†æŠ¥å‘Š
    â””â”€â”€ processing_report.html
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. Stage è‡ªåŠ¨å‘ç°
```bash
# æ‰«ææ‰€æœ‰å¯ç”¨çš„ stage ç›®å½•
find /output/imputed_matrices_by_stage -maxdepth 1 -type d -name "E*"
```

### 2. ç¡¬ä»¶æ£€æµ‹é€»è¾‘
```bash
detect_gpu() {
    if [[ $(uname -m) == "arm64" ]] && python -c "import torch; print(torch.backends.mps.is_available())" 2>/dev/null | grep -q "True"; then
        echo "mps"
    elif nvidia-smi >/dev/null 2>&1; then
        echo "cuda" 
    else
        echo "cpu"
    fi
}
```

### 3. æ™ºèƒ½å¤„ç†é€‰æ‹©
- **MPS**: `build_stage_h5ad_mps.py --distance-features`
- **CUDA**: `build_stage_h5ad_cuda.py --distance-features`  
- **CPU**: `build_stage_h5ad_simple.py`

### 4. è¿›åº¦ç›‘æ§
```bash
# å®æ—¶æ˜¾ç¤ºå¤„ç†è¿›åº¦
echo "ğŸ”„ å¤„ç† Stage E70 (1/3): åˆå¹¶çŸ©é˜µ..."
echo "â±ï¸  é¢„è®¡å‰©ä½™æ—¶é—´: 5åˆ†é’Ÿ"
echo "ğŸ’¾ å†…å­˜ä½¿ç”¨: 2.1GB / 16GB"
```

## ğŸ“Š é¢„æœŸæ•ˆæœ

### å¿«é€Ÿæµ‹è¯• (--mode test)
```bash
./run.sh --mode test --test-cells 3
```
- 3ä¸ª stages Ã— 3ä¸ªç»†èƒ = 9ä¸ªæ ·æœ¬
- é¢„è®¡è¿è¡Œæ—¶é—´: 2-5åˆ†é’Ÿ
- éªŒè¯å®Œæ•´æµæ°´çº¿åŠŸèƒ½

### å…¨é‡å¤„ç† (--mode all)
```bash
./run.sh --mode all --use-distance
```
- å¤„ç†æ‰€æœ‰å¯ç”¨stages
- ä½¿ç”¨è·ç¦»ç‰¹å¾ä¼˜åŒ–æ€§èƒ½
- è‡ªåŠ¨ç¡¬ä»¶åŠ é€Ÿ

### å®šåˆ¶å¤„ç†
```bash
./run.sh --mode stage --stages E70,E80 --max-cells 50 --gpu-type mps
```
- ä»…å¤„ç† E70 å’Œ E80
- æ¯ä¸ªstageæœ€å¤š50ä¸ªç»†èƒ
- å¼ºåˆ¶ä½¿ç”¨ MPS åŠ é€Ÿ

## ğŸ¯ ä¼˜åŒ–å»ºè®®

1. **æç¤ºè¯ä¼˜åŒ–**:
   - æ¸…æ™°çš„è¿›åº¦æŒ‡ç¤ºå’Œæ—¶é—´é¢„ä¼°
   - å½©è‰²è¾“å‡ºå¢å¼ºå¯è¯»æ€§
   - è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®

2. **æ€§èƒ½ä¼˜åŒ–**:
   - é»˜è®¤ä½¿ç”¨è·ç¦»ç‰¹å¾ (4K vs 114M ç»´)
   - æ™ºèƒ½æ‰¹å¤„ç†å¤§å°è°ƒæ•´
   - å†…å­˜ä½¿ç”¨ç›‘æ§å’Œé¢„è­¦

3. **ç”¨æˆ·ä½“éªŒ**:
   - äº¤äº’å¼æ¨¡å¼é€‰æ‹©
   - ç»“æœå¯è§†åŒ–é¢„è§ˆ
   - ä¸€é”®å¼ç¯å¢ƒæ£€æŸ¥

---

**ä¸‹ä¸€æ­¥**: åŸºäºæ­¤è®¡åˆ’å®ç° `run.sh` è„šæœ¬ ğŸš€
