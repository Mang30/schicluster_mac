# Hi-C数据UMAP可视化系统

## 项目概述

本项目基于插补后的单细胞Hi-C数据，按照不同发育阶段(Stage)绘制UMAP图，并创建复合可视化图表。系统设计用于处理7个发育阶段(E70, E75, E80, E85, E95, EX05, EX15)的插补后Hi-C矩阵数据，生成与参考图FigC.png一致的可视化结果。

## 数据流程架构

### 输入数据结构
```
@output/imputed_matrices_by_stage/
├── E70/
│   ├── GasdE701001/
│   │   ├── GasdE701001_chr1_pad1_std1.0_rp0.5_sqrtvc.npz
│   │   ├── GasdE701001_chr2_pad1_std1.0_rp0.5_sqrtvc.npz
│   │   └── ...（20个染色体）
│   └── ...（更多细胞）
├── E75/
├── E80/
├── E85/
├── E95/
├── EX05/
└── EX15/
```

### 输出数据结构
```
@output/
├── hic_h5ad_files/              # 各stage的AnnData文件
│   ├── E70_hic.h5ad
│   ├── E75_hic.h5ad
│   └── ...
├── umap_plots/                  # 单stage UMAP图
│   ├── umap_E70.png
│   ├── umap_E75.png
│   └── ...
├── composite_umap_7stages.png   # 7-stage复合图
└── merged_matrices/             # 临时合并矩阵目录
    ├── E70/
    │   ├── GasdE701001_merged.npz
    │   └── ...
    └── ...
```

## 核心模块设计

### 1. Matrix Merger 模块 (matrix_merger.py)
**功能**: 将每个细胞的20个染色体插补后矩阵合并为完整的细胞Hi-C矩阵

**关键特性**:
- 支持大矩阵的内存优化合并
- 处理不同染色体大小的标准化
- 生成完整的全基因组接触矩阵

### 2. Hi-C AnnData Builder 模块 (hic_anndata_builder.py)
**功能**: 从合并后的Hi-C矩阵构建适合单细胞分析的AnnData对象

**关键特性**:
- 集成细胞metadata和细胞类型信息
- Hi-C特化的数据预处理
- 支持大规模单细胞数据的高效处理

### 3. Hi-C UMAP Visualizer 模块 (hic_umap_visualizer.py)
**功能**: 基于统一颜色映射生成UMAP可视化图表

**关键特性**:
- 严格遵循color_mapping.json的颜色方案
- 生成与FigC.png一致的7-stage复合布局
- 支持Hi-C数据特有的降维和聚类算法

## 技术实现方案

### Hi-C数据处理特化
1. **接触矩阵标准化**: 使用Hi-C特有的标准化方法（如KR标准化或VC-sqrt标准化）
2. **分辨率优化**: 适配100kb分辨率的插补后数据
3. **稀疏矩阵处理**: 高效处理大型稀疏接触矩阵

### 内存优化策略
1. **分块处理**: 大矩阵分块加载和合并
2. **临时文件管理**: 合理使用磁盘缓存避免内存溢出
3. **并行处理**: 支持多进程处理不同stage

### 可视化一致性保证
1. **统一颜色映射**: 严格按照color_mapping.json分配细胞类型颜色
2. **布局标准化**: 7个子图按照E70→E75→E80→E85→E95→EX05→EX15顺序排列
3. **图像质量**: 高分辨率输出，支持publication-ready图表

## 硬件适配 (M4 MacBook 24GB)

### 内存管理
- **批处理大小**: 根据24GB内存限制优化批次大小
- **数据类型优化**: 使用float32代替float64节省内存
- **垃圾回收**: 及时释放不需要的大对象

### 并行计算
- **进程数**: 基于M4芯片特性设置合适的并行进程数
- **温度控制**: 避免长时间高负载导致的过热问题

## 测试策略

### 阶段1: 基础功能测试
- 使用E70, E80, EX05三个完整stage进行测试
- 验证矩阵合并功能的正确性
- 确认AnnData构建的数据完整性

### 阶段2: 可视化测试
- 验证UMAP降维结果的合理性
- 确认颜色映射的一致性
- 对比生成图表与FigC.png的布局匹配度

### 阶段3: 完整流程测试
- 模拟7个stage的完整处理流程
- 性能基准测试和内存使用分析
- 最终复合图表的质量验证

## 执行计划

1. **Phase 1**: 核心模块开发 (1-2天)
   - matrix_merger.py 开发和测试
   - hic_anndata_builder.py 适配开发

2. **Phase 2**: 可视化系统开发 (1天)
   - hic_umap_visualizer.py 开发
   - 颜色映射系统集成

3. **Phase 3**: 测试和优化 (1天)
   - 基于三个完整stage的功能测试
   - 性能优化和bug修复
   - 文档完善和代码整理

## 质量保证

### 代码质量
- 详细的错误处理和日志记录
- 模块化设计便于维护和扩展
- 完整的类型注解和文档字符串

### 数据质量
- 矩阵合并的数值准确性验证
- metadata匹配的完整性检查
- UMAP结果的生物学合理性评估

### 输出质量
- 高分辨率图像输出 (300 DPI)
- 颜色映射的视觉一致性
- 符合科研发表标准的图表格式

## 扩展性设计

系统设计支持未来扩展需求:
- 支持不同分辨率的Hi-C数据
- 支持其他降维方法（如t-SNE, PCA）
- 支持交互式可视化界面
- 支持批量处理多个实验数据集

---

*该文档为Hi-C数据UMAP可视化系统的技术设计文档，基于M4 MacBook 24GB硬件环境优化，适配现有的插补后数据格式。*