# ğŸš€ ä¸€é”®å¯åŠ¨è„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

è¿™ä¸ªä¸€é”®å¯åŠ¨è„šæœ¬ (`run.sh`) æä¾›äº†å®Œæ•´çš„ Hi-C æ•°æ®å¤„ç†æµæ°´çº¿ï¼Œæ”¯æŒï¼š
- è‡ªåŠ¨å‘ç°å’Œå¤„ç†æ‰€æœ‰å¯ç”¨çš„ stages
- æ™ºèƒ½ç¡¬ä»¶æ£€æµ‹ (MPS/CUDA/CPU)
- å®Œæ•´æµæ°´çº¿ï¼šçŸ©é˜µåˆå¹¶ â†’ h5adæ„å»º â†’ UMAPå¯è§†åŒ–
- çµæ´»çš„å‚æ•°é…ç½®å’Œè·³æ­¥æ§åˆ¶

## ğŸ¯ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•
```bash
# å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼ˆæ¨èé¦–æ¬¡ä½¿ç”¨ï¼‰
./run.sh --mode test --use-distance

# ä»…æµ‹è¯• h5ad æ„å»ºï¼ˆè·³è¿‡å…¶ä»–æ­¥éª¤ï¼‰
./run.sh --mode test --test-cells 2 --use-distance --skip-merge --skip-umap
```

### 2. å¤„ç†æŒ‡å®š stages
```bash
# å¤„ç†ç‰¹å®šçš„ stages
./run.sh --mode stage --stages E70,E80 --use-distance

# é™åˆ¶æ¯ä¸ª stage çš„ç»†èƒæ•°
./run.sh --mode stage --stages E70 --max-cells 10 --use-distance
```

### 3. å…¨é‡å¤„ç†ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
```bash
# å¤„ç†æ‰€æœ‰å¯ç”¨çš„ stagesï¼ˆæ¨èç”¨äºæ­£å¼åˆ†æï¼‰
./run.sh --mode all --use-distance

# å¼ºåˆ¶ä½¿ç”¨ CPUï¼ˆå¦‚æœGPUæœ‰é—®é¢˜ï¼‰
./run.sh --mode all --use-distance --gpu-type cpu
```

## ğŸ“Š è¿è¡Œæ¨¡å¼è¯¦è§£

### ğŸ§ª æµ‹è¯•æ¨¡å¼ (`--mode test`)
- ç”¨é€”ï¼šå¿«é€ŸåŠŸèƒ½éªŒè¯
- å¤„ç†èŒƒå›´ï¼šå‰3ä¸ªå‘ç°çš„stages
- é»˜è®¤ç»†èƒæ•°ï¼šæ¯stage 3ä¸ªç»†èƒ
- æ¨èåœºæ™¯ï¼šé¦–æ¬¡ä½¿ç”¨ã€è°ƒè¯•ã€åŠŸèƒ½éªŒè¯

### ğŸ¯ æŒ‡å®šæ¨¡å¼ (`--mode stage`)
- ç”¨é€”ï¼šå¤„ç†ç‰¹å®šçš„stages
- å¤„ç†èŒƒå›´ï¼š`--stages` å‚æ•°æŒ‡å®š
- ç»†èƒæ•°ï¼šå¯é€šè¿‡ `--max-cells` é™åˆ¶
- æ¨èåœºæ™¯ï¼šåˆ†æç‰¹å®šå‘è‚²é˜¶æ®µã€åˆ†æ­¥å¤„ç†

### ğŸš€ å…¨é‡æ¨¡å¼ (`--mode all`)
- ç”¨é€”ï¼šç”Ÿäº§ç¯å¢ƒæ‰¹é‡å¤„ç†
- å¤„ç†èŒƒå›´ï¼šæ‰€æœ‰å‘ç°çš„stages
- ç»†èƒæ•°ï¼šé»˜è®¤å¤„ç†å…¨éƒ¨ç»†èƒ
- æ¨èåœºæ™¯ï¼šæ­£å¼åˆ†æã€è®ºæ–‡æ•°æ®ç”Ÿæˆ

## âš¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ä½¿ç”¨è·ç¦»ç‰¹å¾ï¼ˆå¼ºçƒˆæ¨èï¼‰
```bash
--use-distance    # 4Kç‰¹å¾ vs 114Mç‰¹å¾ï¼Œé€Ÿåº¦æå‡5-10å€
```

### 2. GPUåŠ é€Ÿé€‰æ‹©
```bash
--gpu-type auto   # è‡ªåŠ¨æ£€æµ‹ï¼ˆé»˜è®¤ï¼‰
--gpu-type mps    # Apple Silicon (æ¨èMacç”¨æˆ·)
--gpu-type cuda   # NVIDIA GPU
--gpu-type cpu    # CPUæ¨¡å¼ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
```

### 3. åˆ†æ­¥å¤„ç†
```bash
# å…ˆåˆå¹¶çŸ©é˜µ
./run.sh --mode all --skip-h5ad --skip-umap

# å†æ„å»ºh5ad
./run.sh --mode all --skip-merge --skip-umap --use-distance

# æœ€åç”ŸæˆUMAP
./run.sh --mode all --skip-merge --skip-h5ad
```

## ğŸ“ è¾“å‡ºæ–‡ä»¶ç»„ç»‡

```
output/
â”œâ”€â”€ merged_matrices/          # åˆå¹¶åçš„ç»†èƒçŸ©é˜µ
â”‚   â”œâ”€â”€ E70/
â”‚   â”‚   â”œâ”€â”€ GasfE703172_merged.npz
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”œâ”€â”€ hic_h5ad_files/          # å¤„ç†åçš„h5adæ–‡ä»¶
â”‚   â”œâ”€â”€ E70_processed.h5ad
â”‚   â”œâ”€â”€ E80_processed.h5ad
â”‚   â””â”€â”€ ...
â”œâ”€â”€ umap_plots/              # UMAPå¯è§†åŒ–å›¾è¡¨
â”‚   â”œâ”€â”€ E70_umap.png
â”‚   â”œâ”€â”€ E80_umap.png
â”‚   â””â”€â”€ ...
â”œâ”€â”€ logs/                    # è¿è¡Œæ—¥å¿—
â”‚   â””â”€â”€ run.log
â””â”€â”€ reports/                 # å¤„ç†æŠ¥å‘Š
    â””â”€â”€ summary.json
```

## ğŸ”§ é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰å¤„ç†æµç¨‹
```bash
# ä»…é‡æ–°ç”ŸæˆUMAPï¼ˆh5adæ–‡ä»¶å·²å­˜åœ¨ï¼‰
./run.sh --mode all --skip-merge --skip-h5ad

# ä»çŸ©é˜µåˆå¹¶å¼€å§‹ï¼Œä½†ä¸ç”ŸæˆUMAP
./run.sh --mode all --skip-umap --use-distance

# ä»…å¤„ç†ç‰¹å®šstageçš„UMAP
./run.sh --mode stage --stages E70 --skip-merge --skip-h5ad
```

### æ‰¹é‡å¤„ç†ä¸åŒå‚æ•°ç»„åˆ
```bash
# è„šæœ¬1: å¿«é€Ÿé¢„è§ˆï¼ˆè·ç¦»ç‰¹å¾ï¼‰
./run.sh --mode test --use-distance

# è„šæœ¬2: å®Œæ•´ç‰¹å¾åˆ†æ
./run.sh --mode stage --stages E70 --max-cells 5

# è„šæœ¬3: ç”Ÿäº§ç¯å¢ƒå¤„ç†
./run.sh --mode all --use-distance
```

## ğŸ“Š æ€§èƒ½åŸºå‡†

### å¤„ç†æ—¶é—´ä¼°ç®—
- **æµ‹è¯•æ¨¡å¼**: 3 stages Ã— 3 cells â‰ˆ 2-5åˆ†é’Ÿ
- **å•stageå¤„ç†**: 10 cells â‰ˆ 1-2åˆ†é’Ÿ (è·ç¦»ç‰¹å¾)
- **å…¨é‡å¤„ç†**: å–å†³äºæ•°æ®è§„æ¨¡ï¼Œé€šå¸¸ 10-60åˆ†é’Ÿ

### ç¡¬ä»¶è¦æ±‚
- **å†…å­˜**: å»ºè®® 8GB+ (è·ç¦»ç‰¹å¾) / 32GB+ (å®Œæ•´ç‰¹å¾)
- **å­˜å‚¨**: æ¯ä¸ªstageçº¦ 100MB-1GB è¾“å‡ºæ–‡ä»¶
- **GPU**: MPS(Apple Silicon) > CUDA > CPU

## ğŸ› å¸¸è§é—®é¢˜

### 1. è·¯å¾„é—®é¢˜
- ç¡®ä¿åœ¨ `plotumap` ç›®å½•ä¸‹è¿è¡Œè„šæœ¬
- æ£€æŸ¥ `config/` ç›®å½•æ˜¯å¦åŒ…å«é…ç½®æ–‡ä»¶
- éªŒè¯ `core/` ç›®å½•åŒ…å«æ‰€æœ‰Pythonæ¨¡å—

### 2. å†…å­˜ä¸è¶³
```bash
# ä½¿ç”¨è·ç¦»ç‰¹å¾å‡å°‘å†…å­˜ä½¿ç”¨
./run.sh --mode test --use-distance

# åˆ†æ‰¹å¤„ç†
./run.sh --mode stage --stages E70 --max-cells 5
```

### 3. GPUé—®é¢˜
```bash
# å¼ºåˆ¶ä½¿ç”¨CPU
./run.sh --mode test --gpu-type cpu

# æ£€æŸ¥GPUå¯ç”¨æ€§
python3 -c "import torch; print(f'MPS: {torch.backends.mps.is_available()}')"
```

### 4. Pythonä¾èµ–é—®é¢˜
```bash
# ç¡®ä¿åœ¨æ­£ç¡®çš„condaç¯å¢ƒä¸­
conda activate schicluster

# æ£€æŸ¥å…³é”®åŒ…
python3 -c "import torch, scanpy, anndata; print('Dependencies OK')"
```

## ğŸ“ æ—¥å¿—å’Œç›‘æ§

### æŸ¥çœ‹è¿è¡Œæ—¥å¿—
```bash
# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f output/logs/run.log

# æŸ¥çœ‹å¤„ç†æ€»ç»“
cat output/reports/summary.json
```

### è¿›åº¦ç›‘æ§
è„šæœ¬æä¾›å®æ—¶è¿›åº¦æ¡æ˜¾ç¤ºï¼š
```
[è¿›åº¦] [E70] æ„å»ºh5ad: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 67% (2/3)
```

---

**æç¤º**: å»ºè®®é¦–æ¬¡ä½¿ç”¨æ—¶è¿è¡Œ `./run.sh --mode test --use-distance` è¿›è¡ŒåŠŸèƒ½éªŒè¯ï¼ ğŸ¯
