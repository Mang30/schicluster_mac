# M4 MacBook MPS åŠ é€Ÿå•ç»†èƒ Hi-C æ’è¡¥æ‰§è¡Œè®¡åˆ’

## ç¡¬ä»¶é…ç½®
- **è®¾å¤‡**: M4 MacBook (Apple Silicon)
- **è¿è¡Œå†…å­˜**: 24GB ç»Ÿä¸€å†…å­˜
- **GPUåŠ é€Ÿ**: MPS (Metal Performance Shaders)
- **é¢„æœŸæ€§èƒ½**: 10-15x CPU åŠ é€Ÿæ¯”

## é¡¹ç›®æ¦‚è¿°
å¯¹ `output/pairs2matrix_output/` ä¸­ 7 ä¸ªå‘è‚²é˜¶æ®µçš„å•ç»†èƒ Hi-C æ•°æ®è¿›è¡Œ MPS åŠ é€Ÿæ’è¡¥å¤„ç†ã€‚

## æ•°æ®ç»Ÿè®¡
- **æ•°æ®æº**: `/Volumes/SumSung500/CSU/0_HiRES/output/pairs2matrix_output/`
- **å‘è‚²é˜¶æ®µ**: E70, E75, E80, E85, E95, EX05, EX15 (å…±7ä¸ªé˜¶æ®µ)
- **æ€»ç»†èƒæ•°**: ~7,476ä¸ªç»†èƒ
- **æ¯ç»†èƒæŸ“è‰²ä½“**: 20ä¸ª (chr1-19, chrX)
- **é¢„è®¡æ€»çŸ©é˜µæ•°**: ~149,520ä¸ª

### å„é˜¶æ®µç»†èƒç»Ÿè®¡
| å‘è‚²é˜¶æ®µ | ç»†èƒæ•°é‡ | é¢„è®¡çŸ©é˜µæ•° |
|---------|---------|-----------|
| E70     | ~557    | ~11,140   |
| E75     | ~1,870  | ~37,400   |
| E80     | ~559    | ~11,180   |
| E85     | ~1,125  | ~22,500   |
| E95     | ~1,108  | ~22,160   |
| EX05    | ~1,128  | ~22,560   |
| EX15    | ~1,122  | ~22,440   |
| **æ€»è®¡** | **7,469** | **149,380** |

## å¹¶è¡Œä»»åŠ¡åˆ†é…ç­–ç•¥

### 6ä¸ª Bash ä»»åŠ¡ (M4 24GB å†…å­˜ä¼˜åŒ–)
- **Task 1**: E70 + E80 (~1,116ç»†èƒ) - æ—©æœŸé˜¶æ®µåˆå¹¶
- **Task 2**: E75 (~1,870ç»†èƒ) - æœ€å¤§é˜¶æ®µç‹¬ç«‹å¤„ç†  
- **Task 3**: E85 (~1,125ç»†èƒ) - ä¸­æœŸé˜¶æ®µç‹¬ç«‹
- **Task 4**: E95 (~1,108ç»†èƒ) - ä¸­æœŸé˜¶æ®µç‹¬ç«‹
- **Task 5**: EX05 (~1,128ç»†èƒ) - åæœŸé˜¶æ®µç‹¬ç«‹
- **Task 6**: EX15 (~1,122ç»†èƒ) - åæœŸé˜¶æ®µç‹¬ç«‹

## æŠ€æœ¯æ¶æ„

### MPS åŠ é€Ÿé…ç½®
- **æ‰¹æ¬¡å¤§å°**: 8-12 (å……åˆ†åˆ©ç”¨24GBå†…å­˜)
- **MPSè®¾å¤‡**: `torch.device('mps')`
- **å†…å­˜ç®¡ç†**: åŠ¨æ€åˆ†é…ï¼Œé¿å…å†…å­˜ç¢ç‰‡
- **æ¸©åº¦ç›‘æ§**: M4èŠ¯ç‰‡æ¸©åº¦ä¿æŠ¤æœºåˆ¶

### è¾“å…¥è¾“å‡ºè·¯å¾„
```
è¾“å…¥: /Volumes/SumSung500/CSU/0_HiRES/output/pairs2matrix_output/
      â”œâ”€â”€ E70/GasdE701001/GasdE701001_chr1.txt
      â”œâ”€â”€ E75/GasaE751001/GasaE751001_chr1.txt
      â””â”€â”€ ...

è¾“å‡º: /Volumes/SumSung500/CSU/0_HiRES/output/imputed_matrices_by_stage/
      â”œâ”€â”€ E70/GasdE701001/GasdE701001_chr1_pad1_std1.0_rp0.5_sqrtvc.npz
      â”œâ”€â”€ E75/GasaE751001/GasaE751001_chr1_pad1_std1.0_rp0.5_sqrtvc.npz
      â””â”€â”€ ...
```

## æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µ1: è„šæœ¬å¼€å‘å’Œé€‚é… âœ…
1. âœ… åˆ›å»º CLAUDE.md æ–‡æ¡£
2. âœ… åˆ›å»º M4 ä¼˜åŒ–çš„ MPS æ’è¡¥ä¸»æ§è„šæœ¬
3. âœ… ä¿®æ”¹ batch_mps_imputation.py é€‚é… pairs2matrix_output æ•°æ®æº
4. âœ… åˆ›å»º 6 ä¸ªå¹¶è¡Œ bash ä»»åŠ¡è„šæœ¬
5. âœ… é…ç½® M4 24GB å†…å­˜ä¼˜åŒ–å‚æ•°
6. âœ… æ›´æ–°è·¯å¾„ä» lwh_code åˆ° lwh_schicluster_impute_code

### é˜¶æ®µ2: ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ âœ…
1. âœ… åˆ›å»ºè¿›åº¦ç›‘æ§è„šæœ¬
2. âœ… è®¾ç½®å®æ—¶æ—¥å¿—è®°å½•
3. âœ… ç³»ç»Ÿèµ„æºç›‘æ§
4. âœ… åˆ›å»ºç¯å¢ƒæµ‹è¯•è„šæœ¬

### é˜¶æ®µ3: æµ‹è¯•å’ŒéªŒè¯ ğŸ”„
1. ğŸ”„ ç¯å¢ƒä¾èµ–æµ‹è¯•
2. ğŸ”„ å°è§„æ¨¡æµ‹è¯•ï¼ˆå•ç»†èƒéªŒè¯ï¼‰
3. ğŸ”„ å®Œæ•´å¹¶è¡Œæ‰§è¡Œ
4. ğŸ”„ è´¨é‡éªŒè¯å’ŒæŠ¥å‘Š

## æ€§èƒ½é¢„ä¼° (M4 24GB é…ç½®)

### å¤„ç†æ—¶é—´é¢„ä¼°
- **å•æŸ“è‰²ä½“æ—¶é—´**: ~0.08-0.15ç§’ (M4 ä¼˜åŒ–)
- **å•ç»†èƒæ—¶é—´**: ~1.6-3.0ç§’ (20ä¸ªæŸ“è‰²ä½“)
- **Task 1 (E70+E80)**: ~3-5å°æ—¶
- **Task 2 (E75)**: ~8-12å°æ—¶  
- **Task 3-6**: å„ ~3-6å°æ—¶
- **æ€»é¢„è®¡æ—¶é—´**: 12-20å°æ—¶ (6ä»»åŠ¡å¹¶è¡Œ)

### èµ„æºä½¿ç”¨
- **CPU åˆ©ç”¨ç‡**: 80-95% (6ä¸ªPythonè¿›ç¨‹)
- **GPU åˆ©ç”¨ç‡**: 85-95% (MPSå¹¶å‘)
- **å†…å­˜ä½¿ç”¨**: 18-22GB (å……åˆ†åˆ©ç”¨24GB)
- **æ¸©åº¦æ§åˆ¶**: è‡ªåŠ¨é¢‘ç‡è°ƒèŠ‚ä¿æŠ¤M4èŠ¯ç‰‡

## è´¨é‡ä¿è¯

### æ•°æ®éªŒè¯
- **è¾“å…¥æ ¼å¼**: bin1 bin2 count (åˆ¶è¡¨ç¬¦åˆ†éš”)
- **è¾“å‡ºæ ¼å¼**: .npz æ’è¡¥åçš„æ¥è§¦çŸ©é˜µ
- **å®Œæ•´æ€§æ£€æŸ¥**: 20ä¸ªæŸ“è‰²ä½“æ–‡ä»¶å®Œæ•´æ€§
- **æ•°å€¼éªŒè¯**: æ’è¡¥åçŸ©é˜µæ•°å€¼èŒƒå›´æ£€æŸ¥

### é”™è¯¯å¤„ç†
- **æ–­ç‚¹ç»­ä¼ **: è‡ªåŠ¨è·³è¿‡å·²å®Œæˆçš„çŸ©é˜µ
- **é”™è¯¯é‡è¯•**: å¤±è´¥ä»»åŠ¡è‡ªåŠ¨é‡è¯•æœºåˆ¶
- **æ—¥å¿—è®°å½•**: è¯¦ç»†çš„é”™è¯¯å’Œè­¦å‘Šè®°å½•
- **èµ„æºç›‘æ§**: å†…å­˜æº¢å‡ºå’Œæ¸©åº¦å¼‚å¸¸ä¿æŠ¤

## é¢„æœŸè¾“å‡ºç»“æ„
```
output/imputed_matrices_by_stage/
â”œâ”€â”€ E70/
â”‚   â”œâ”€â”€ GasdE701001/
â”‚   â”‚   â”œâ”€â”€ GasdE701001_chr1_pad1_std1.0_rp0.5_sqrtvc.npz
â”‚   â”‚   â”œâ”€â”€ GasdE701001_chr2_pad1_std1.0_rp0.5_sqrtvc.npz
â”‚   â”‚   â””â”€â”€ ... (20ä¸ªæŸ“è‰²ä½“)
â”‚   â””â”€â”€ ...
â”œâ”€â”€ E75/
â”œâ”€â”€ E80/
â”œâ”€â”€ E85/
â”œâ”€â”€ E95/
â”œâ”€â”€ EX05/
â””â”€â”€ EX15/
```

## åç»­åº”ç”¨
æ’è¡¥å®Œæˆçš„ .npz çŸ©é˜µæ–‡ä»¶å¯ç›´æ¥ç”¨äºï¼š
1. å•ç»†èƒ Hi-C æ•°æ®åˆ†æ
2. æŸ“è‰²è´¨ç»“æ„ç ”ç©¶
3. å‘è‚²é˜¶æ®µæ¯”è¾ƒåˆ†æ
4. schicluster ä¸‹æ¸¸åˆ†ææµç¨‹

## ä½¿ç”¨æŒ‡å—

### å¿«é€Ÿå¼€å§‹
```bash
# è¿›å…¥è„šæœ¬ç›®å½•
cd /Volumes/SumSung500/CSU/0_HiRES/lwh_schicluster_impute_code/imputation_mac

# è¿è¡Œå¿«é€Ÿæµ‹è¯•ï¼ˆè‡ªåŠ¨æ¿€æ´»schiclusterç¯å¢ƒï¼‰
bash quick_test.sh
```

### æ‰‹åŠ¨æ­¥éª¤
```bash
# 1. æ¿€æ´»ç¯å¢ƒ
eval "$(micromamba shell hook --shell bash)"
micromamba activate schicluster

# 2. ç¯å¢ƒæµ‹è¯•
python test_environment.py

# 3. å•ç»†èƒæµ‹è¯•
python batch_mps_imputation_v2.py --stages E70 --max-cells 1

# 4. å®Œæ•´æ‰§è¡Œ
bash start_parallel_imputation.sh
```

### ç›‘æ§å‘½ä»¤
```bash
# å®æ—¶ç›‘æ§
python monitor_progress.py

# ä¸€æ¬¡æ€§çŠ¶æ€
python monitor_progress.py --once

# ç”ŸæˆæŠ¥å‘Š  
python monitor_progress.py --summary
```

### æ–‡ä»¶æ¸…å•
- `batch_mps_imputation_v2.py`: M4ä¼˜åŒ–çš„MPSæ’è¡¥è„šæœ¬
- `parallel_imputation_controller.py`: 6ä»»åŠ¡å¹¶è¡Œæ§åˆ¶å™¨
- `task1-6_imputation.sh`: 6ä¸ªå¹¶è¡Œä»»åŠ¡è„šæœ¬
- `monitor_progress.py`: è¿›åº¦ç›‘æ§è„šæœ¬
- `test_environment.py`: ç¯å¢ƒæµ‹è¯•è„šæœ¬
- `quick_test.sh`: å¿«é€Ÿæµ‹è¯•è„šæœ¬
- `start_parallel_imputation.sh`: äº¤äº’å¯åŠ¨è„šæœ¬

---
**åˆ›å»ºæ—¶é—´**: 2025-08-23  
**ç¡¬ä»¶å¹³å°**: M4 MacBook 24GB  
**ç¯å¢ƒè¦æ±‚**: micromamba schicluster  
**é¢„è®¡å®Œæˆ**: 12-20å°æ—¶ (6ä»»åŠ¡å¹¶è¡Œ)  
**çŠ¶æ€**: å¼€å‘å®Œæˆï¼Œå‡†å¤‡æµ‹è¯• âœ…