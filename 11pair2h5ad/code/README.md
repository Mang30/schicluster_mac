# Hi-C Pairs to H5AD è½¬æ¢å™¨ (å†…å­˜ä¼˜åŒ–ç‰ˆ)

æœ¬ä»£ç ç”¨äºå°†ç»†èƒ Hi-C pairs æ•°æ®è½¬æ¢ä¸º scanpy å…¼å®¹çš„ h5ad æ ¼å¼ï¼Œæ”¯æŒåˆ†æ‰¹å¤„ç†ä»¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨ã€‚

## æ–‡ä»¶è¯´æ˜

- `pairs_to_h5ad_converter.py`: æ ¸å¿ƒè½¬æ¢å™¨ç±»ï¼Œæ”¯æŒåˆ†æ‰¹å¤„ç†
- `run_conversion.py`: ä¾¿æ·è¿è¡Œè„šæœ¬ï¼Œå†…ç½®å†…å­˜ä¼˜åŒ–é…ç½®
- `README.md`: ä½¿ç”¨è¯´æ˜

## å†…å­˜ä¼˜åŒ–ç‰¹æ€§

### ğŸš€ åˆ†æ‰¹å¤„ç†
- **é»˜è®¤æ‰¹å¤§å°**: 200ä¸ªç»†èƒ/æ‰¹
- **å†…å­˜éœ€æ±‚**: ~30GB â†’ ~4-8GB
- **å¤„ç†æ—¶é—´**: ç•¥æœ‰å¢åŠ ï¼Œä½†å¯ä»¥åœ¨æ™®é€šæœºå™¨ä¸Šè¿è¡Œ

### ğŸ’¾ æ•°æ®ç²¾åº¦ä¼˜åŒ–
- **float32**: é»˜è®¤é€‰é¡¹ï¼ŒèŠ‚çœ50%å†…å­˜
- **float64**: é«˜ç²¾åº¦é€‰é¡¹ï¼Œéœ€è¦æ›´å¤šå†…å­˜

### ğŸ¯ æ¥è§¦è¿‡æ»¤
- **æœ€å°æ¥è§¦æ•°**: è¿‡æ»¤ä½è´¨é‡æ¥è§¦ï¼Œå‡å°‘æ•°æ®é‡
- **é»˜è®¤é˜ˆå€¼**: 2æ¬¡æ¥è§¦

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä¾¿æ·è„šæœ¬ (æ¨è)

```bash
cd /Volumes/SumSung500/CSU/0_HiRES/11pair2h5ad/code

# é»˜è®¤é…ç½® (æ¨èï¼šæ‰¹å¤§å°200ï¼Œfloat32ï¼Œè¿‡æ»¤â‰¥2æ¬¡æ¥è§¦)
/Users/wuhaoliu/mamba/envs/schicluster/bin/python run_conversion.py

# è‡ªå®šä¹‰æ‰¹å¤§å° (é€‚åˆä¸åŒå†…å­˜é…ç½®)
/Users/wuhaoliu/mamba/envs/schicluster/bin/python run_conversion.py --batch_size 100

# é«˜ç²¾åº¦æ¨¡å¼
/Users/wuhaoliu/mamba/envs/schicluster/bin/python run_conversion.py --use_float64

# ä¸åˆ†æ‰¹æ¨¡å¼ (éœ€è¦32-64GBå†…å­˜)
/Users/wuhaoliu/mamba/envs/schicluster/bin/python run_conversion.py --no_batch
```

### æ–¹æ³•2: ç›´æ¥ä½¿ç”¨è½¬æ¢å™¨

```bash
# åŸºæœ¬ç”¨æ³•
/Users/wuhaoliu/mamba/envs/schicluster/bin/python pairs_to_h5ad_converter.py \
    --cell_table ../cell_table.tsv \
    --output ../output/hic_data_100k.h5ad \
    --batch_size 200 \
    --min_contacts 2

# é«˜æ€§èƒ½é…ç½® (éœ€è¦å¤§å†…å­˜)
/Users/wuhaoliu/mamba/envs/schicluster/bin/python pairs_to_h5ad_converter.py \
    --cell_table ../cell_table.tsv \
    --output ../output/hic_data_100k_highperf.h5ad \
    --use_float64 \
    --min_contacts 1 \
    --verbose
```

## å‚æ•°è¯¦ç»†è¯´æ˜

### æ ¸å¿ƒå‚æ•°
- `--cell_table`: cell_table.tsv æ–‡ä»¶è·¯å¾„
- `--output`: è¾“å‡º h5ad æ–‡ä»¶è·¯å¾„
- `--resolution`: åˆ†è¾¨ç‡ï¼ˆé»˜è®¤: 100000ï¼Œå³100Kï¼‰

### å†…å­˜ä¼˜åŒ–å‚æ•°
- `--batch_size`: åˆ†æ‰¹å¤„ç†å¤§å°ï¼ˆé»˜è®¤: Noneï¼Œæ¨è: 100-500ï¼‰
- `--use_float64`: ä½¿ç”¨float64ç²¾åº¦ï¼ˆé»˜è®¤: float32ï¼‰
- `--min_contacts`: æœ€å°æ¥è§¦æ¬¡æ•°é˜ˆå€¼ï¼ˆé»˜è®¤: 1ï¼‰

### å…¶ä»–å‚æ•°
- `--verbose`: è¯¦ç»†è¾“å‡ºæ¨¡å¼

## å†…å­˜éœ€æ±‚æŒ‡å—

| é…ç½® | æ‰¹å¤§å° | ç²¾åº¦ | é¢„ä¼°å†…å­˜ | é€‚ç”¨åœºæ™¯ |
|------|--------|------|----------|----------|
| ä½å†…å­˜ | 50 | float32 | 4-8GB | æ™®é€šç¬”è®°æœ¬ |
| å¹³è¡¡ | 200 | float32 | 8-16GB | å·¥ä½œç«™ |
| é«˜æ€§èƒ½ | 500 | float32 | 16-32GB | é«˜æ€§èƒ½æœåŠ¡å™¨ |
| æé€Ÿ | ä¸åˆ†æ‰¹ | float64 | 64-128GB | å¤§å†…å­˜æœåŠ¡å™¨ |

## è¾“å‡ºæ–‡ä»¶å‘½å

è¾“å‡ºæ–‡ä»¶åè‡ªåŠ¨æ ¹æ®é…ç½®ç”Ÿæˆï¼š
```
hic_data_100k_{precision}_{batch_info}_min{min_contacts}.h5ad
```

ç¤ºä¾‹ï¼š
- `hic_data_100k_float32_batch200_min2.h5ad`
- `hic_data_100k_float64_nobatch_min1.h5ad`

## è¾“å…¥æ•°æ®æ ¼å¼

### cell_table.tsv
```
GasaE751001    /path/to/GSM6998595_GasaE751001.pairs.gz
GasaE751002    /path/to/GSM6998596_GasaE751002.pairs.gz
...
```

### pairs.gz æ–‡ä»¶æ ¼å¼
æ ‡å‡† Hi-C pairs æ ¼å¼ï¼ŒåŒ…å«æŸ“è‰²ä½“é—´ç›¸äº’ä½œç”¨æ•°æ®ï¼š
```
## pairs format v1.0
#sorted: chr1-chr2-pos1-pos2
#chromosome: chr1 195471971
#chromosome: chr2 182113224
...
.    chr1    3052398    chr1    4307873    +    +    .    .
```

## è¾“å‡ºæ•°æ®

ç”Ÿæˆçš„ h5ad æ–‡ä»¶åŒ…å«ï¼š
- **X**: ç»†èƒ Ã— æŸ“è‰²ä½“æ¥è§¦ç‰¹å¾çŸ©é˜µ (ä¸Šä¸‰è§’å±•å¹³)
- **obs**: ç»†èƒæ³¨é‡Šä¿¡æ¯
- **var**: ç‰¹å¾æ³¨é‡Šä¿¡æ¯ (åŸºå› ç»„åŒºé—´å¯¹)
- **uns**: å…ƒæ•°æ® (åˆ†è¾¨ç‡ã€æŸ“è‰²ä½“ä¿¡æ¯ã€å¤„ç†å‚æ•°ç­‰)

### å…ƒæ•°æ® (uns) åŒ…å«
- `resolution`: åˆ†è¾¨ç‡
- `chromosomes`: æŸ“è‰²ä½“åˆ—è¡¨
- `chr_lengths`: æŸ“è‰²ä½“é•¿åº¦
- `bin_mapping`: åˆ†ç®±æ˜ å°„ä¿¡æ¯
- `total_bins`: æ€»åˆ†ç®±æ•°
- `min_contacts`: æ¥è§¦è¿‡æ»¤é˜ˆå€¼
- `use_float32`: æ•°æ®ç²¾åº¦è®¾ç½®

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å†…å­˜ä¸è¶³æ—¶
1. å‡å°‘æ‰¹å¤§å°ï¼š`--batch_size 50`
2. ä½¿ç”¨float32ï¼šé»˜è®¤å·²å¯ç”¨
3. æé«˜è¿‡æ»¤é˜ˆå€¼ï¼š`--min_contacts 3`

### åŠ é€Ÿå¤„ç†æ—¶
1. å¢åŠ æ‰¹å¤§å°ï¼š`--batch_size 500`
2. ä½¿ç”¨SSDå­˜å‚¨
3. å…³é—­å…¶ä»–ç¨‹åºé‡Šæ”¾å†…å­˜

## ä¾èµ–åŒ…

ç¡®ä¿ schicluster ç¯å¢ƒä¸­å®‰è£…äº†ä»¥ä¸‹åŒ…ï¼š
- pandas
- numpy
- scanpy
- anndata
- scipy
- tqdm

## æ•…éšœæ’é™¤

### å¸¸è§é”™è¯¯
1. **å†…å­˜ä¸è¶³**: å‡å°‘batch_sizeæˆ–ä½¿ç”¨float32
2. **æ–‡ä»¶è·¯å¾„é”™è¯¯**: æ£€æŸ¥cell_table.tsvä¸­çš„è·¯å¾„
3. **ç£ç›˜ç©ºé—´ä¸è¶³**: ç¡®ä¿è¾“å‡ºç›®å½•æœ‰è¶³å¤Ÿç©ºé—´

### ç›‘æ§è¿›åº¦
- ä½¿ç”¨ `--verbose` å‚æ•°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
- æ¯100ä¸ªç»†èƒä¼šè¾“å‡ºè¿›åº¦ä¿¡æ¯
- åˆ†æ‰¹æ¨¡å¼ä¸‹æ¯æ‰¹å®Œæˆåæ˜¾ç¤ºè¿›åº¦

## æ³¨æ„äº‹é¡¹

1. **å†…å­˜è§„åˆ’**: æ ¹æ®å¯ç”¨å†…å­˜é€‰æ‹©åˆé€‚çš„batch_size
2. **æ—¶é—´é¢„ä¼°**: 7,469ä¸ªç»†èƒé¢„è®¡éœ€è¦2-6å°æ—¶
3. **å­˜å‚¨ç©ºé—´**: è¾“å‡ºæ–‡ä»¶å¯èƒ½è¾¾åˆ°10-50GB
4. **ç¨³å®šè¿è¡Œ**: å»ºè®®åœ¨ç¨³å®šçš„æœåŠ¡å™¨ç¯å¢ƒä¸­è¿è¡Œ
5. **åç»­åˆ†æ**: h5adæ–‡ä»¶å¯ç›´æ¥ç”¨äºscanpyåˆ†æ